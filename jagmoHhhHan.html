<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PBX-0008 NCLEX-RN</title>

<style>
*{ box-sizing:border-box; }

body{
  margin:0;
  font-family: Arial, Helvetica, sans-serif;
  background:#eef3f8;
  overflow:hidden;
}

:root{
  --navy: #005b96;
  --navy-light: #5086b3;
  --google-blue: #1a73e8;
  --calc-red: #8b0000;
  --calc-blue: #004080;
  --glass: rgba(255, 255, 255, 0.8);
}

/* TOP BAR */
.topbar{
  height:44px;
  background:var(--navy);
  color:white;
  padding:0 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:14px;
}
.top-left{ font-weight:bold; display: flex; align-items: center; gap: 10px;}

@keyframes glarYellowRed {
  0% { color: inherit; text-shadow: 0 0 2px rgba(255, 255, 0, 0.3); }
  25% { color: #FFD700; text-shadow: 0 0 10px rgba(255, 255, 0, 0.8); }
  50% { color: #FFA500; text-shadow: 0 0 15px rgba(255, 165, 0, 0.8); }
  75% { color: #f8a98c; text-shadow: 0 0 15px rgba(255, 69, 0, 0.8); }
  100% { color: inherit; text-shadow: 0 0 2px rgba(255, 94, 94, 0.555); }
}

.pbx-glare {
  animation: glarYellowRed 3s ease-in-out infinite;
  font-weight: bold;
  display: inline-block;
}
.top-center{ position: absolute; left: 50%; transform: translateX(-50%); color: white; font-weight: bold; font-size: 14px; }

#typewriter {
  color: white;
  border-right: 2px solid rgba(255,255,255,0.75);
  white-space: nowrap;
  overflow: hidden;
  padding-left: 10px;
  min-width: 120px;
}
.cursor-blink { animation: blink 0.7s infinite; }
@keyframes blink { 50% { border-color: transparent; } }

.calc-strip{
  height:36px;
  background:var(--navy-light);
  color:white;
  padding:0 16px;
  display:grid;
  grid-template-columns:1fr auto 1fr;
  align-items:center;
  font-size:13px;
}

.main{
  height:calc(100vh - 44px - 36px - 44px);
  display:grid;
  grid-template-columns:1fr 1fr;
}

.left, .right{ overflow-y:auto; padding:24px; }
.left{ background:white; border-right:1px solid #bacada; }
.right{ background:#f8fafc; }

.option {
    padding: 14px 14px 14px 45px;
    margin-bottom: 8px;
    cursor: pointer;
    position: relative;
    border-radius: 4px;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: 0.2s;
}

.option:hover { background: #f0f7ff; }
.option.selected { background: #e0efff; border: 1px solid var(--navy-light); }
.option.correct { border-left: 5px solid #1bad22; }
.option.wrong { border-left: 5px solid #ff2828; }

#questionResultBox {
  display: none;
  background: #fff;
  border-left: 8px solid #ccc;
  margin-top: 20px;
  padding: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.bottombar{
  height:44px;
  background:var(--navy);
  padding:0 16px;
  display:flex;
  justify-content:flex-end;
  align-items:center;
}

button {
  background:var(--navy-light);
  color:white;
  border:none;
  padding:8px 16px;
  margin-left:10px;
  cursor:pointer;
  font-weight:bold;
}
</style>
</head>

<body>

<div class="topbar">
  <div class="top-left">
    <span class="pbx-glare">PBX-0008</span> NCLEX-RN
    <div id="typewriter" class="cursor-blink"></div>
  </div>
  <div class="top-center" id="qidDisplay">QID. ----</div>
  <div class="top-right">
    <span id="scoreBox">Score: 0 / 0 (0%)</span>
    <span id="timeBox" style="margin-left:15px;">Time: 00:00</span>
  </div>
</div>

<div class="calc-strip">
  <div class="calc-left">Calculator</div>
  <div class="calc-center"><span class="pbx-glare">PBX-0008</span> SYSTEM</div>
  <div class="calc-right" id="rightStrip">
    <input type="file" id="fileInput" accept=".txt,.json" onchange="loadFile(event)">
  </div>
</div>

<div class="main">
  <div class="left">
    <div id="caseStudyContainer"></div>
    <div class="qtext" id="question" style="font-size:18px; margin-bottom:20px; font-weight:bold;">
        Please upload a .json or .txt file to begin the session.
    </div>
    <div id="options"></div>
    <div class="check-btn" style="margin-top:20px;"><button onclick="check()">Check Answer</button></div>
    
    <div id="questionResultBox">
        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; text-align:center;">
            <div><b id="ind-score">0/0</b><br><small>SCORE</small></div>
            <div><b id="ind-subject">General</b><br><small>SUBJECT</small></div>
            <div><b id="ind-topic">General</b><br><small>TOPIC</small></div>
        </div>
    </div>
  </div>
  <div class="right">
    <div id="explanation" style="line-height:1.6;">Explanation will appear here after checking the answer.</div>
  </div>
</div>

<div class="bottombar">
  <button onclick="prevQ()">◀ Previous</button>
  <button onclick="nextQ()">Next ▶</button>
</div>

<script>
let DATA = { questionList: [] };
let qIndex = 0, selected = [], score = 0, total = 0, sec = 0;
let timer = null, questionsLoaded = false;

function loadFile(e) {
  const f = e.target.files[0];
  if (!f) return;

  const r = new FileReader();
  r.onload = () => {
    try {
      const content = JSON.parse(r.result);
      // Handle cases where JSON might be at root or inside questionList
      DATA = content.questionList ? content : { questionList: Array.isArray(content) ? content : [content] };
      
      if (DATA.questionList.length === 0) throw new Error("No questions found");

      DATA.questionList.forEach(q => {
        q.submitted = false;
        q.userAnswer = [];
        q.timeTaken = 0;
      });

      questionsLoaded = true;
      qIndex = 0; score = 0; total = 0; sec = 0;
      render();
      startTimer();
      alert("File loaded successfully: " + DATA.questionList.length + " questions.");
    } catch (err) {
      alert("Error: File is not a valid JSON format. Check console for details.");
      console.error(err);
    }
  };
  r.readAsText(f);
}

function render() {
  if (!DATA.questionList.length) return;
  const q = DATA.questionList[qIndex];
  selected = q.userAnswer || [];
  
  document.getElementById("qidDisplay").innerText = `QID. ${q.questionId || "----"}`;
  document.getElementById("rightStrip").innerHTML = `Question ${qIndex + 1} of ${DATA.questionList.length}`;
  document.getElementById("question").innerHTML = q.questionText;

  const optBox = document.getElementById("options");
  optBox.innerHTML = "";

  q.answerChoiceList.forEach((c, i) => {
    const d = document.createElement("div");
    d.className = "option";
    if (selected.includes(i)) d.classList.add("selected");
    
    if (q.submitted) {
      const correctArr = q.correctAnswer.split(",").map(x => parseInt(x.trim()) - 1);
      if (correctArr.includes(i)) d.classList.add("correct");
      if (selected.includes(i) && !correctArr.includes(i)) d.classList.add("wrong");
    }

    d.innerHTML = c.choice;
    d.onclick = () => {
      if (q.submitted) return;
      if (selected.includes(i)) {
        selected = selected.filter(x => x !== i);
      } else {
        selected.push(i);
      }
      q.userAnswer = selected;
      render();
    };
    optBox.appendChild(d);
  });

  if (q.submitted) {
    document.getElementById("explanation").innerHTML = "<h3>Explanation</h3>" + q.explanationText;
    document.getElementById("questionResultBox").style.display = "block";
    document.getElementById("ind-score").innerText = q.qScore + "/" + q.qMax;
    document.getElementById("ind-subject").innerText = q.subject || "General";
  } else {
    document.getElementById("explanation").innerText = "Explanation will appear here after clicking Check.";
    document.getElementById("questionResultBox").style.display = "none";
  }
}

function check() {
  const q = DATA.questionList[qIndex];
  if (!q || q.submitted) return;

  const correctArr = q.correctAnswer.split(",").map(x => parseInt(x.trim()) - 1);
  let correctHits = 0, wrongHits = 0;

  selected.forEach(i => correctArr.includes(i) ? correctHits++ : wrongHits++);
  
  q.qScore = Math.max(0, correctHits - wrongHits);
  q.qMax = correctArr.length;
  q.submitted = true;
  
  score += q.qScore;
  total += q.qMax;
  updateTopBar();
  render();
}

function nextQ() { if (qIndex < DATA.questionList.length - 1) { qIndex++; render(); } }
function prevQ() { if (qIndex > 0) { qIndex--; render(); } }

function startTimer() {
  if (timer) clearInterval(timer);
  timer = setInterval(() => {
    sec++;
    updateTopBar();
  }, 1000);
}

function updateTopBar() {
  let p = total ? Math.round((score / total) * 100) : 0;
  let m = String(Math.floor(sec / 60)).padStart(2, '0');
  let s = String(sec % 60).padStart(2, '0');
  document.getElementById("scoreBox").innerText = `Score: ${score} / ${total} (${p}%)`;
  document.getElementById("timeBox").innerText = `Time: ${m}:${s}`;
}
</script>

</body>
</html>
